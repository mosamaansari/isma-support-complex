generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model AdminUser {
  id               String    @id @default(cuid())
  username         String    @unique
  password         String
  role             String    @default("admin")
  name             String
  email            String?
  profilePicture   String?
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@map("admin_users")
}

model User {
  id               String                @id @default(cuid())
  username         String                @unique
  password         String
  name             String
  email            String?
  permissions      String[]              @default([])
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  profilePicture   String?
  resetToken       String?
  resetTokenExpiry DateTime?
  role             String                @default("cashier")
  openingBalances  DailyOpeningBalance[]

  @@map("users")
}

model Product {
  id                     String         @id @default(cuid())
  name                   String
  category               String?
  salePrice              Decimal?       @db.Decimal(10, 2)
  minStockLevel          Int            @default(0)
  barcode                String?
  image                  String?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  categoryId             String?
  description            String?
  manufacturer           String?
  model                  String?
  shopQuantity           Int            @default(0)
  warehouseQuantity      Int            @default(0)
  createdBy              String?
  createdByType          String?
  updatedBy              String?
  updatedByType          String?
  lowStockNotifiedAt     DateTime?
  shopMinStockLevel      Int            @default(0)
  warehouseMinStockLevel Int            @default(0)
  brand                  String?
  brandId                String?
  brandRef               Brand?         @relation(fields: [brandId], references: [id])
  categoryRef            Category?      @relation(fields: [categoryId], references: [id])
  purchaseItems          PurchaseItem[]
  saleItems              SaleItem[]

  @@map("products")
}

model Customer {
  id             String   @id @default(cuid())
  name           String
  phone          String
  email          String?
  address        String?
  totalPurchases Decimal  @default(0) @db.Decimal(10, 2)
  dueAmount      Decimal  @default(0) @db.Decimal(10, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  city           String?
  sales          Sale[]

  @@map("customers")
}

model Supplier {
  id             String     @id @default(cuid())
  name           String
  phone          String
  email          String?
  address        String?
  totalPurchases Decimal    @default(0) @db.Decimal(10, 2)
  dueAmount      Decimal    @default(0) @db.Decimal(10, 2)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  createdBy      String?
  createdByType  String?
  updatedBy      String?
  updatedByType  String?
  purchases      Purchase[]

  @@unique([name, phone], name: "supplier_name_phone")
  @@map("suppliers")
}

model Sale {
  id                  String               @id @default(cuid())
  billNumber          String               @unique
  subtotal            Decimal              @db.Decimal(10, 2)
  discount            Decimal              @default(0) @db.Decimal(10, 2)
  tax                 Decimal              @default(0) @db.Decimal(10, 2)
  total               Decimal              @db.Decimal(10, 2)
  paymentType         PaymentType          @default(cash)
  status              SaleStatus           @default(completed)
  customerId          String?
  customerName        String?
  customerPhone       String?
  userId              String
  userName            String
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  cardId              String?
  bankAccountId       String?
  date                DateTime             @default(now())
  payments            Json?
  remainingBalance    Decimal              @default(0) @db.Decimal(10, 2)
  createdBy           String?
  createdByType       String?
  updatedBy           String?
  updatedByType       String?
  customerCity        String?
  discountType        String?              @default("percent")
  taxType             String?              @default("percent")
  balanceTransactions BalanceTransaction[] @relation("SaleBalanceTransactions")
  items               SaleItem[]
  bankAccount         BankAccount?         @relation(fields: [bankAccountId], references: [id])
  card                Card?                @relation(fields: [cardId], references: [id])
  customer            Customer?            @relation(fields: [customerId], references: [id])

  @@map("sales")
}

model SaleItem {
  id                String   @id @default(cuid())
  saleId            String
  productId         String
  productName       String
  quantity          Int
  unitPrice         Decimal  @db.Decimal(10, 2)
  discount          Decimal  @default(0) @db.Decimal(10, 2)
  tax               Decimal  @default(0) @db.Decimal(10, 2)
  total             Decimal  @db.Decimal(10, 2)
  createdAt         DateTime @default(now())
  fromWarehouse     Boolean  @default(false)
  customPrice       Decimal? @db.Decimal(10, 2)
  discountType      String?  @default("percent")
  taxType           String?  @default("percent")
  shopQuantity      Int      @default(0)
  warehouseQuantity Int      @default(0)
  priceType         String?  @default("single")
  priceSingle       Decimal? @db.Decimal(10, 2)
  priceDozen        Decimal? @db.Decimal(10, 2)
  product           Product  @relation(fields: [productId], references: [id])
  sale              Sale     @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("sale_items")
}

model Expense {
  id                  String               @id @default(cuid())
  amount              Decimal              @db.Decimal(10, 2)
  category            String?              @db.VarChar(100)
  description         String?
  date                DateTime             @default(now())
  userId              String
  userName            String
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  bankAccountId       String?
  paymentType         PaymentType          @default(cash)
  cardId              String?
  createdBy           String?
  createdByType       String?
  updatedBy           String?
  updatedByType       String?
  expenseCategoryId   String?
  balanceTransactions BalanceTransaction[] @relation("ExpenseBalanceTransactions")
  bankAccount         BankAccount?         @relation(fields: [bankAccountId], references: [id])
  card                Card?                @relation(fields: [cardId], references: [id])
  expenseCategoryRef  ExpenseCategory?     @relation(fields: [expenseCategoryId], references: [id])

  @@map("expenses")
}

model Purchase {
  id                  String               @id @default(cuid())
  supplierId          String?
  supplierName        String
  total               Decimal              @db.Decimal(10, 2)
  date                DateTime             @default(now())
  userId              String
  userName            String
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  payments            Json?
  remainingBalance    Decimal              @default(0) @db.Decimal(10, 2)
  subtotal            Decimal              @db.Decimal(10, 2)
  supplierPhone       String?
  tax                 Decimal              @default(0) @db.Decimal(10, 2)
  createdBy           String?
  createdByType       String?
  status              PurchaseStatus       @default(completed)
  updatedBy           String?
  updatedByType       String?
  discount            Decimal              @default(0) @db.Decimal(10, 2)
  discountType        String?              @default("percent")
  taxType             String?              @default("percent")
  balanceTransactions BalanceTransaction[] @relation("PurchaseBalanceTransactions")
  items               PurchaseItem[]
  supplier            Supplier?            @relation(fields: [supplierId], references: [id])

  @@map("purchases")
}

model PurchaseItem {
  id                String   @id @default(cuid())
  purchaseId        String
  productId         String
  productName       String
  quantity          Int
  cost              Decimal  @db.Decimal(10, 2)
  total             Decimal  @db.Decimal(10, 2)
  createdAt         DateTime @default(now())
  discount          Decimal  @default(0) @db.Decimal(10, 2)
  toWarehouse       Boolean  @default(true)
  shopQuantity      Int      @default(0)
  warehouseQuantity Int      @default(0)
  priceType         String?  @default("single")
  costSingle        Decimal? @db.Decimal(10, 2)
  costDozen         Decimal? @db.Decimal(10, 2)
  discountType      String?  @default("percent")
  product           Product  @relation(fields: [productId], references: [id])
  purchase          Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@map("purchase_items")
}

model ShopSettings {
  id                String   @id @default(cuid())
  shopName          String
  logo              String
  contactNumber     String
  email             String
  address           String
  bankAccountNumber String?  @default("")
  bankName          String?  @default("")
  ifscCode          String?  @default("")
  gstNumber         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("shop_settings")
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@map("categories")
}

model Brand {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@map("brands")
}

model ExpenseCategory {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  expenses    Expense[]

  @@map("expense_categories")
}

model Card {
  id            String    @id @default(cuid())
  name          String
  cardNumber    String?
  bankName      String?
  accountHolder String?
  isDefault     Boolean   @default(false)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String?
  createdByType String?
  updatedBy     String?
  updatedByType String?
  expenses      Expense[]
  sales         Sale[]

  @@map("cards")
}

model BankAccount {
  id                 String               @id @default(cuid())
  accountName        String
  accountNumber      String
  bankName           String
  ifscCode           String?              @default("")
  accountHolder      String?
  branchName         String?
  isDefault          Boolean              @default(false)
  isActive           Boolean              @default(true)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  createdBy          String?
  createdByType      String?
  updatedBy          String?
  updatedByType      String?
  BalanceTransaction BalanceTransaction[]
  expenses           Expense[]
  sales              Sale[]

  @@unique([accountNumber, bankName])
  @@map("bank_accounts")
}

model DailyOpeningBalance {
  id            String   @id @default(cuid())
  date          DateTime @unique @db.Date
  cashBalance   Decimal  @default(0) @db.Decimal(10, 2)
  cardBalances  Json?
  notes         String?
  userId        String?
  userName      String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?
  createdByType String?
  updatedBy     String?
  updatedByType String?
  bankBalances  Json?
  user          User?    @relation(fields: [userId], references: [id])

  @@map("daily_opening_balances")
}

model DailyConfirmation {
  id              String    @id @default(cuid())
  date            DateTime  @unique @db.Date
  confirmed       Boolean   @default(false)
  confirmedBy     String?
  confirmedByType String?
  confirmedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("daily_confirmations")
}

model BalanceTransaction {
  id            String       @id @default(cuid())
  date          DateTime     @db.Date
  type          String
  amount        Decimal      @db.Decimal(10, 2)
  paymentType   String
  bankAccountId String?
  description   String?
  source        String?
  sourceId      String?
  userId        String
  userName      String
  createdAt     DateTime     @default(now())
  afterBalance  Decimal?     @db.Decimal(10, 2)
  beforeBalance Decimal?     @db.Decimal(10, 2)
  changeAmount  Decimal?     @db.Decimal(10, 2)
  expenseId     String?
  purchaseId    String?
  saleId        String?
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id])
  expense       Expense?     @relation("ExpenseBalanceTransactions", fields: [expenseId], references: [id])
  purchase      Purchase?    @relation("PurchaseBalanceTransactions", fields: [purchaseId], references: [id])
  sale          Sale?        @relation("SaleBalanceTransactions", fields: [saleId], references: [id])

  @@index([date])
  @@index([paymentType])
  @@index([bankAccountId])
  @@index([source, sourceId])
  @@map("balance_transactions")
}

model DailyClosingBalance {
  id           String   @id @default(cuid())
  date         DateTime @unique @db.Date
  cashBalance  Decimal  @default(0) @db.Decimal(10, 2)
  bankBalances Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  cardBalances Json?

  @@map("daily_closing_balances")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  label       String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("roles")
}

enum UserRole {
  superadmin
  admin
  cashier
  warehouse_manager
}

enum RegularUserRole {
  cashier
  warehouse_manager
}

enum PaymentType {
  cash
  bank_transfer
}

enum SaleStatus {
  completed
  cancelled
  pending
}

enum PurchaseStatus {
  completed
  pending
  cancelled
}
